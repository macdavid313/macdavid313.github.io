<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Notes on Deploying Common Lisp Web Services</title><meta name=author content="Tianyu Gu"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Xanh+Mono&display=swap" rel=stylesheet><style type=text/css>body{font-family:monospace}code{color:#000;font-family:fira code,monospace;font-size:small}blockquote{font-family:xanh mono,monospace}figure{margin-top:3%;margin-bottom:3%;margin-left:5%;margin-right:5%}table,th,td{border:1px solid #fff}</style></head><body><header>=========<br>== <a href=https://macdavid313.xyz/>gty</a> ==<br>=========<div style=float:right>You gotta go away to come back.</div><br><p><nav><a href=/about/><b>about</b></a>.
<a href=/wiki/><b>wiki</b></a>.
<a href=/posts/><b>posts</b></a>.
<a href=/tags/><b>tags</b></a>.
<a href=/cat/><b>cat</b></a>.
<a href=/playlists/><b>playlists</b></a>.</nav></p></header><main><article><h1>Notes on Deploying Common Lisp Web Services</h1><b><time>Mar 27, 2017, Monday</time></b>
<a href=/tags/lisp>lisp,</a>
<a href=/tags/web>web</a><div><p>I’m recently finishing a Common Lisp web service used inside a company. An essential part of the reason why I choose Lisp in this case is, <strong>CLOS</strong>, one of the most powerful tools for designing complicated concepts. It’s a nice experience using CLOS to successfully solve some hard problems along with extending some components.</p><p>However, the embarrassing thing is I’ve never delivered a web application before, all I know is developing, debugging within SLIME and writing some scripts to deliver a binary executable so far. Web applications, however, are long-running services (or better said, “processes”). Once the services are started, you’d wish there are some tools to stop or restart them, basically. And if the service crashes somehow or the machine just has restarted due to some maintenance, it would be wonderful that the service itself could restart automatically. In this article, I therefore try to introduce <em>two</em> solutions that may just work for whoever is or will be searching for similar questions on the Internet.</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>1. TMUX</h3><div id=outline-text-headline-1 class=outline-text-3><p><strong>tmux</strong><sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> is a software application that can be used to multiplex several virtual consoles, allowing a user to access multiple separate terminal sessions inside a single terminal window or remote terminal session. Before I got used to Emacs, I used tmux way much more to manage sessions on Linux. After all, Emacs is just an editor, no matter how much I love it. By using <strong>tmux</strong>, one can attach/detach sessions in an absolutely <em>sane</em> way. So, here are some recipes.</p><div id=outline-container-headline-2 class=outline-4><h4 id=headline-2>1.1 for creating a new session</h4><div id=outline-text-headline-2 class=outline-text-4><div class="src src-sh"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tmux new -s session-name</code></pre></div></div></div></div><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>1.2 for attaching a session</h4><div id=outline-text-headline-3 class=outline-text-4><div class="src src-sh"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tmux a -t session-name</code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>1.3 for detaching from a session</h4><div id=outline-text-headline-4 class=outline-text-4><div class="src src-sh"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tmux detach <span style=color:#60a0b0;font-style:italic># or use the shortcut &#39;Ctrl-b d&#39;</span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>1.4 for killing a session</h4><div id=outline-text-headline-5 class=outline-text-4><div class="src src-sh"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tmux kill-session -t session-name</code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-4><h4 id=headline-6>1.5 for sending keys to a session</h4><div id=outline-text-headline-6 class=outline-text-4><div class="src src-sh"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tmux send-keys -t session-name <span style=color:#4070a0>&#34;(+ 1 2 3)&#34;</span> C-m</code></pre></div></div><p>One might be curious what does <code class=verbatim>send-keys</code> subcommand do exactly. In the above example, first imagine we already have a session where SBCL got started, tmux then sent an expression <code>(+ 1 2 3)</code> to Lisp followed by a <code class=verbatim>new line</code> which is indicated by <code class=verbatim>C-m</code>:</p><p><figure><img src=/img/tmux_send_keys_example.gif></figure></p><p>Now you can see, by using <code class=verbatim>send-keys</code>, one can write shell scripts to start, stop, reload (<strong>fasl</strong> files), restart lisp services or just send any expressions to evaluate without putting too much efforts into it. For more information about tmux’s commands, please check its <a href=http://man.openbsd.org/OpenBSD-current/man1/tmux.1>manual</a>.</p><p>## 2. Supervisor</p><p><strong>tmux</strong> is both powerful and flexible, however, it can not tell us (through, for example, logging) if the server crashed or even restarted itself automatically after an unexpected crashed. We thus need some sort of processes management tool.</p><p><strong>Supervisor</strong> is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems<sup class=footnote-reference><a id=footnote-reference-2 href=#footnote-2>2</a></sup>. This is a piece of Python software, and it is for Python 2.x only. I’m definitely not the first one who came up with using this tool, as a matter of fact, way back at 2013, <a href=https://github.com/fukamachi>Fukamachi</a> wrote an <a href=http://blog.8arrow.org/entry/20130320/1363787619>essay</a> talking about how he managed to deploy <strong>Quickdocs<sup class=footnote-reference><a id=footnote-reference-3 href=#footnote-3>3</a></sup></strong> web services. In that paper, <strong>Supervisor</strong> along with <strong>Nginx</strong> is proposed, and <strong>Clack</strong>, a piece of software written by himself was used as well.</p><p>Fukamachi didn’t write the essay in English, unfortunately, but it’s not hard to understand what he proposed. Basically, one can prepare a <strong>Makefile</strong> like this to start the service:</p><div class="src src-text"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>SERVER_PORT=8000
SWANK_PORT=4005

define sbcl
	sbcl --noinform --disable-debugger \
		--load /home/david/quicklisp/setup.lisp \
		--eval &#39;(progn $1)&#39; \
		--eval &#39;(progn $2)&#39;
endef

start:
	$(call sbcl, \
		(ql:quickload :lucerne-hello-world) (ql:quickload :swank), \
		(lucerne:start lucerne-hello-world:app :port $(SERVER_PORT)) \
		(swank:create-server :port $(SWANK_PORT) :style :spawn :dont-close t))</code></pre></div></div><p>Then define your service in <em>supervisord.conf</em>:</p><div class="src src-text"><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[program:lucerne]
command=make -f /paht-to-your-Makefile/Makefile start
directory=/your-project-path
numprocs=1
autostart=true
autorestart=true
user=david
redirect_stderr=true
stdout_logfile=/var/log/supervisor/lucerne-hello-world.log</code></pre></div></div><p>For more information about how to use <strong>Supervisor</strong>, please check its documentation which is very comprehensive and easy to understand. The last thing I want to discuss is, within the above <strong>Makefile</strong> example, one may notice that we start a <strong>swank</strong> server besides the Lisp web service. <strong>Supervisor</strong> can indeed monitor services, but what about if we want to compile lisp code even when the service is running? That is, we don’t want to issue <code>sudo service supervisor restart</code> but just re-compile and load pieces of <strong>fasl</strong> files into the original Lisp image and keep it running. Within Emacs, one can manage to achieve that goal by issuing <code>M-x slime-connect 127.0.0.1 4005</code><sup class=footnote-reference><a id=footnote-reference-4 href=#footnote-4>4</a></sup> and then start to re-compile (<code>C-c C-c</code>) definitions or just inspect and debug, dynamically. In the end, one can even connect to a Lisp image which is deployed at a remote machine. Please check the documentation at this <a href=https://common-lisp.net/project/slime/doc/html/Connecting-to-a-remote-lisp.html#Connecting-to-a-remote-lisp>page</a>.</p></div></div></div></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Wikipedia, tmux, [<a href=https://en.wikipedia.org/wiki/Tmux](https://en.wikipedia.org/wiki/Tmux)>https://en.wikipedia.org/wiki/Tmux](https://en.wikipedia.org/wiki/Tmux)</a></p></div></div><div class=footnote-definition><sup id=footnote-2><a href=#footnote-reference-2>2</a></sup><div class=footnote-body><p>Supervisor: A Process Control System, [<a href=http://supervisord.org](http://supervisord.org/)>http://supervisord.org](http://supervisord.org/)</a></p></div></div><div class=footnote-definition><sup id=footnote-3><a href=#footnote-reference-3>3</a></sup><div class=footnote-body><p>Quickdocs, Library Documentation Hosting for Common Lisp, [<a href=http://quickdocs.org](http://quickdocs.org/)>http://quickdocs.org](http://quickdocs.org/)</a></p></div></div><div class=footnote-definition><sup id=footnote-4><a href=#footnote-reference-4>4</a></sup><div class=footnote-body><p>If your specified the port 4005 for swank, of course.</p></div></div></div></div></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/10-years-after-gaokao/>十年后，回望高考和高中的时光</a></li><li><a href=/posts/wind-river-movie/>猎凶风河谷（电影）</a></li><li><a href=/posts/ibm-model-m-arrived/>IBM Model M 来了</a></li><li><a href=/posts/from-push-up-to-pull-up/>从"俯卧撑"到"引体向上"</a></li><li><a href=/posts/lisp-while-lang/>Common Lisp Solution to While Language</a></li></ul></div></div></aside><footer><p>&copy; 2021 <a href=https://macdavid313.xyz/><b>gty</b></a>.
<a href=mailto:macdavid313@gmail.com><b>email</b></a>.
<a href=/assets/pgp-public.txt><b>PGP</b></a>.
<a href=https://github.com/macdavid313><b>github</b></a>.
<a href=https://www.instagram.com/davidgu357/><b>instagram</b></a>.</p></footer></body></html>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Embedding Julia in Lisp</title><meta name=author content="Tianyu Gu"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Xanh+Mono&display=swap" rel=stylesheet><style type=text/css>body{font-family:monospace}code{color:#000;font-family:fira code,monospace;font-size:small}blockquote{font-family:xanh mono,monospace}figure{margin-top:3%;margin-bottom:3%;margin-left:5%;margin-right:5%}table,th,td{border:1px solid #fff}</style></head><body><header>=========<br>== <a href=https://macdavid313.xyz/>gty</a> ==<br>=========<div style=float:right>You gotta go away to come back.</div><br><p><nav><a href=/about/><b>about</b></a>.
<a href=/wiki/><b>wiki</b></a>.
<a href=/posts/><b>posts</b></a>.
<a href=/tags/><b>tags</b></a>.
<a href=/cat/><b>cat</b></a>.
<a href=/playlists/><b>playlists</b></a>.</nav></p></header><main><article><h1>Embedding Julia in Lisp</h1><b><time>Mar 19, 2017, Sunday</time></b>
<a href=/tags/lisp>lisp</a>
<a href=/tags/julia>julia</a><div><p>Julia is a high-level dynamic programming language designed to address the needs of high-performance numerical analysis and computational science while also being effective for general-purpose programming, web use or as a specification language<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. I like its Lisp-like macros and <a href=https://en.wikipedia.org/wiki/Multiple_dispatch>multiple dispatch</a> strategy. After all, it’s from MIT, where LISP happens. Its performance, according to this <a href=http://julialang.org/images/julia-dynamic-2012-tr.pdf>paper</a>, is often within a factor of two relative to fully optimized C code (and thus often an order of magnitude faster than Python or R)<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Besides macros (or other meta-programming facilities), multiple dispatch and high performance. Julia can call Python (by using PyCall<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> package) and C functions (without wrappers). This support may be very important for a new community programming language.</p><p>Anyway, Julia looks very promising. Since most Lisp has a bad (and somewhat unfair at all) reputation for performance, I’m thinking about one can embed Julia into Lisp systems and make it like an agent for numerical computation tasks. Common Lisp community already has a package called <code>burgled-batteries</code>, by using which people can calling Python 2.7<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> functions, massive libraries and functionalities become available for Common Lisp, therefore.</p><p>But after I tried to embed Julia in SBCL, unfortunately, memory errors took place. Here is a session on Ubuntu 16.04:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=color:#bb60d5>david@ubuntu-512mb-fra1-01:~/julia$</span> <span style=color:#bb60d5>sbcl</span> <span style=color:#bb60d5>--load</span> <span style=color:#bb60d5>~/quicklisp/setup.lisp</span>
<span style=color:#bb60d5>This</span> <span style=color:#bb60d5>is</span> <span style=color:#bb60d5>SBCL</span> <span style=color:#bb60d5>1.3.15.10-1c20666,</span> <span style=color:#bb60d5>an</span> <span style=color:#bb60d5>implementation</span> <span style=color:#bb60d5>of</span> <span style=color:#bb60d5>ANSI</span> <span style=color:#bb60d5>Common</span> <span style=color:#bb60d5>Lisp.</span>
<span style=color:#bb60d5>More</span> <span style=color:#bb60d5>information</span> <span style=color:#bb60d5>about</span> <span style=color:#bb60d5>SBCL</span> <span style=color:#bb60d5>is</span> <span style=color:#bb60d5>available</span> <span style=color:#bb60d5>at</span> <span style=color:#bb60d5>&lt;http://www.sbcl.org/&gt;.</span>

<span style=color:#bb60d5>SBCL</span> <span style=color:#bb60d5>is</span> <span style=color:#bb60d5>free</span> <span style=color:#bb60d5>software,</span> <span style=color:#bb60d5>provided</span> <span style=color:#bb60d5>as</span> <span style=color:#bb60d5>is,</span> <span style=color:#bb60d5>with</span> <span style=color:#bb60d5>absolutely</span> <span style=color:#bb60d5>no</span> <span style=color:#bb60d5>warranty.</span>
<span style=color:#bb60d5>It</span> <span style=color:#bb60d5>is</span> <span style=color:#bb60d5>mostly</span> <span style=color:#bb60d5>in</span> <span style=color:#007020;font-weight:700>the</span> <span style=color:#bb60d5>public</span> <span style=color:#bb60d5>domain</span><span style=color:#60a0b0;font-style:italic>; some portions are provided under</span>
<span style=color:#bb60d5>BSD-style</span> <span style=color:#bb60d5>licenses.</span>  <span style=color:#bb60d5>See</span> <span style=color:#007020;font-weight:700>the</span> <span style=color:#bb60d5>CREDITS</span> <span style=color:#007020>and</span> <span style=color:#bb60d5>COPYING</span> <span style=color:#bb60d5>files</span> <span style=color:#bb60d5>in</span> <span style=color:#007020;font-weight:700>the</span>
<span style=color:#bb60d5>distribution</span> <span style=color:#bb60d5>for</span> <span style=color:#bb60d5>more</span> <span style=color:#bb60d5>information.</span>
<span style=color:#06287e>*</span> (<span style=color:#bb60d5>ql:quickload</span> <span style=color:#517918>:cffi</span>)
<span style=color:#bb60d5>To</span> <span style=color:#06287e>load</span> <span style=color:#4070a0>&#34;cffi&#34;</span><span>:</span>
  <span style=color:#bb60d5>Load</span> <span style=color:#40a070>1</span> <span style=color:#bb60d5>ASDF</span> <span style=color:#bb60d5>system:</span>
    <span style=color:#bb60d5>cffi</span>
<span style=color:#60a0b0;font-style:italic>; Loading &#34;cffi&#34;</span>
<span style=color:#666>.</span>
(<span style=color:#517918>:CFFI</span>)
<span style=color:#06287e>*</span> (<span style=color:#bb60d5>cffi:load-foreign-library</span> <span style=color:#4070a0>&#34;/home/david/julia/lib/libjulia.so&#34;</span>)

<span>#</span><span style=color:#bb60d5>&lt;CFFI:FOREIGN-LIBRARY</span> <span style=color:#bb60d5>LIBJULIA.SO-483</span> <span style=color:#4070a0>&#34;libjulia.so&#34;</span><span style=color:#06287e>&gt;</span>
<span style=color:#06287e>*</span> (<span style=color:#bb60d5>cffi:defcfun</span> (<span style=color:#4070a0>&#34;jl_init&#34;</span> <span style=color:#bb60d5>jl-init</span>) <span style=color:#517918>:void</span> (<span style=color:#bb60d5>julia-home-dir</span> <span style=color:#517918>:string</span>))

<span style=color:#bb60d5>JL-INIT</span>
<span style=color:#06287e>*</span> (<span style=color:#bb60d5>jl-init</span> <span style=color:#4070a0>&#34;/home/david/julia/lib&#34;</span>)

<span style=color:#06287e>*</span> (<span style=color:#bb60d5>cffi:defcfun</span> (<span style=color:#4070a0>&#34;jl_eval_string&#34;</span> <span style=color:#bb60d5>jl-eval-string</span>) <span style=color:#517918>:pointer</span> (<span style=color:#bb60d5>str</span> <span style=color:#517918>:string</span>))
<span style=color:#bb60d5>fatal:</span> <span style=color:#902000>error</span> <span style=color:#bb60d5>thrown</span> <span style=color:#007020>and</span> <span style=color:#bb60d5>no</span> <span style=color:#bb60d5>exception</span> <span style=color:#bb60d5>handler</span> <span style=color:#bb60d5>available.</span>
<span style=color:#bb60d5>ReadOnlyMemoryError</span>()
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba66dd</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b8a105</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba62c6</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba6046</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba5be1</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba58af</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba55bc</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21ba5488</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b320e2</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b69702</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b3aead</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b3a3a7</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b3a3a7</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21b39621</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21dd95f3</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x22245a59</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21e138e9</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21e7b711</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21e13505</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x21e12dac</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x2253592a</span>)
<span style=color:#bb60d5>unknown</span> <span style=color:#0e84b5;font-weight:700>function</span> (<span style=color:#bb60d5>ip:</span> <span style=color:#bb60d5>0x2253563e</span>)
<span style=color:#bb60d5>call_into_lisp</span> <span style=color:#bb60d5>at</span> <span style=color:#bb60d5>sbcl</span> (<span style=color:#bb60d5>unknown</span> <span style=color:#bb60d5>line</span>)
</code></pre></div><p>This process failed on CCL as well, but ECL survived so far, which makes this bug more confusing. While I think it’s an internal error in Lisp implementations, @开源哥 suggested it might come from Julia side.</p><p>However, on the other hand, things work pretty well on Chez Scheme:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>*julia-root-path*</span> <span style=color:#4070a0>&#34;/home/david/julia/&#34;</span>)

(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>*julia-lib-path*</span>
  (<span style=color:#007020>string-append </span><span style=color:#bb60d5>*julia-root-path*</span> <span style=color:#4070a0>&#34;lib/&#34;</span>))

(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>*libjulia*</span>
  (<span style=color:#007020>string-append </span><span style=color:#bb60d5>*julia-lib-path*</span> <span style=color:#4070a0>&#34;libjulia.so&#34;</span>))

(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>jl-init</span>
  (<span style=color:#06287e>foreign-procedure</span> <span style=color:#4070a0>&#34;jl_init&#34;</span> (<span style=color:#06287e>string</span>) <span style=color:#bb60d5>void*</span>))

(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>jl-eval-string</span>
  (<span style=color:#06287e>foreign-procedure</span> <span style=color:#4070a0>&#34;jl_eval_string&#34;</span> (<span style=color:#06287e>string</span>) <span style=color:#bb60d5>void*</span>))

(<span style=color:#007020;font-weight:700>define </span><span style=color:#bb60d5>jl-unbox-float64</span>
  (<span style=color:#06287e>foreign-procedure</span> <span style=color:#4070a0>&#34;jl_unbox_float64&#34;</span> (<span style=color:#06287e>void*</span>) <span style=color:#bb60d5>double-float</span>))

(<span style=color:#06287e>load-shared-object</span> <span style=color:#bb60d5>*libjulia*</span>)
(<span style=color:#06287e>jl-init</span> <span style=color:#bb60d5>*julia-lib-path*</span>)

(<span style=color:#06287e>jl-eval-string</span> <span style=color:#4070a0>&#34;sqrt(2.0)&#34;</span>)
<span style=color:#60a0b0;font-style:italic>;; =&gt; 4694870240</span>

(<span style=color:#06287e>jl-unbox-float64</span> (<span style=color:#06287e>jl-eval-string</span> <span style=color:#4070a0>&#34;sqrt(2.0)&#34;</span>))
<span style=color:#60a0b0;font-style:italic>;; =&gt; 1.4142135623730951</span>
</code></pre></div><p>On Julia’s documentation page, there’s one <a href=https://docs.julialang.org/en/v1/manual/embedding/>chapter</a> talking about embedding specifically, where these topics are outlined:</p><ol><li>Loading dynamic library and initializing Julia runtime</li><li>Converting Types</li><li>Calling Julia Functions</li><li>Memory Management and GC</li><li>Arrays</li><li>Exceptions</li></ol><p>You will find it will be easier to embed Julia than e.g. CPython into Lisp or any other system, especially for the memory management part, where CPython uses <code>reference counting</code> which is somewhat painful for maintaining. If one can solve the problem shown before on SBCL and CCL, Common Lisp community may have another package calling Julia functions in the future. So if anyone knows how to deal with it, please tell me or just fix it and implement the package “in one breath”.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Wikipedia, Julia (programming language), <a href=https://en.wikipedia.org/wiki/Julia_(programming_language)>https://en.wikipedia.org/wiki/Julia_(programming_language)</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Jeff Bezanson, Stefan Karpinski, Viral B. Shah, Alan Edelman, <a href=https://arxiv.org/abs/1209.5145>Julia: A Fast Dynamic Language for Technical Computing</a>, 2012. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://medium.com/@acidflask/smoothing-data-with-julia-s-generated-functions-c80e240e05f3#.615wk3dle>“Smoothing data with Julia’s @generated functions”</a>. 5 November 2015. Retrieved 9 December 2015. “Julia’s generated functions are closely related to the multistaged programming (MSP) paradigm popularized by Taha and Sheard, which generalizes the compile time/run time stages of program execution by allowing for multiple stages of delayed code execution.” <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>Note: Python 3.x might be available as well, please see this <a href=https://github.com/pinterface/burgled-batteries/pull/8>pull request</a> on Github. <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/10-years-after-gaokao/>十年后，回望高考和高中的时光</a></li><li><a href=/posts/wind-river-movie/>猎凶风河谷（电影）</a></li><li><a href=/posts/ibm-model-m-arrived/>IBM Model M 来了</a></li><li><a href=/posts/from-push-up-to-pull-up/>从"俯卧撑"到"引体向上"</a></li><li><a href=/posts/lisp-while-lang/>Common Lisp Solution to While Language</a></li></ul></div></div></aside><footer><p>&copy; 2021 <a href=https://macdavid313.xyz/><b>gty</b></a>.
<a href=mailto:macdavid313@gmail.com><b>email</b></a>.
<a href=/assets/pgp-public.txt><b>PGP</b></a>.
<a href=https://github.com/macdavid313><b>github</b></a>.
<a href=https://www.instagram.com/davidgu357/><b>instagram</b></a>.</p></footer></body></html>